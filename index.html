<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeedPage Dev-Bot v2.6</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            /* Modern Indigo */
            --primary-light: #818cf8;
            --bg-gradient: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --bot-bubble: rgba(255, 255, 255, 0.1);
            --user-bubble: #6366f1;
            --accent: #10b981;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            max-width: 900px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            margin: 20px;
            position: relative;
        }

        /* Header */
        header {
            padding: 24px;
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bot-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bot-avatar {
            width: 45px;
            height: 45px;
            background: var(--primary);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: white;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
        }

        .bot-status h1 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            margin-right: 4px;
        }

        .lang-switcher {
            display: flex;
            background: var(--glass-bg);
            padding: 4px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
        }

        .lang-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .lang-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Chat Window */
        #chat-window {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) transparent;
        }

        #chat-window::-webkit-scrollbar {
            width: 6px;
        }

        #chat-window::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .msg {
            max-width: 80%;
            padding: 14px 18px;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .msg.bot {
            align-self: flex-start;
            background: var(--bot-bubble);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--glass-border);
        }

        .msg.user {
            align-self: flex-end;
            background: var(--user-bubble);
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3);
        }

        .code-block {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 12px;
            border-radius: 12px;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            margin-top: 10px;
            overflow-x: auto;
            border-left: 4px solid var(--primary);
        }

        .file-ref {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--accent);
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Controls */
        .controls {
            padding: 0 24px 12px 24px;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 12px;
            scrollbar-width: none;
        }

        .quick-actions::-webkit-scrollbar {
            display: none;
        }

        .action-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .guide-container {
            margin-bottom: 12px;
        }

        #fileSelect {
            width: 100%;
            background: #2e2a5e;
            /* Solid color for better readability */
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 12px;
            border-radius: 12px;
            outline: none;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            font-size: 0.9rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        #fileSelect:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        #fileSelect option {
            background: #1e1b4b;
            /* Deep Indigo - darker than the select */
            color: var(--text-main);
            padding: 10px;
        }

        /* Input Area */
        #input-area {
            padding: 24px;
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 12px;
            border-bottom-left-radius: 24px;
            border-bottom-right-radius: 24px;
        }

        input {
            flex: 1;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 14px 20px;
            border-radius: 16px;
            outline: none;
            font-size: 1rem;
            transition: all 0.3s;
        }

        input:focus {
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            background: var(--primary);
            border: none;
            border-radius: 16px;
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            transition: all 0.3s;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
        }

        .typing-indicator {
            padding: 0 24px 8px 24px;
            color: var(--text-muted);
            font-size: 0.8rem;
            display: none;
        }

        .typing-indicator span {
            display: inline-block;
            animation: bounce 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-4px);
            }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-body {
            background: #1e1b4b;
            border: 1px solid var(--glass-border);
            padding: 32px;
            border-radius: 24px;
            width: 100%;
            max-width: 450px;
            position: relative;
        }

        .modal-body h3 {
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .modal-body input,
        .modal-body select {
            width: 100%;
            margin-bottom: 16px;
        }

        /* Markdown Helper */
        .markdown-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 0.85rem;
        }

        .markdown-table th,
        .markdown-table td {
            border: 1px solid var(--glass-border);
            padding: 8px;
            text-align: left;
        }

        .markdown-table th {
            background: rgba(255, 255, 255, 0.05);
        }

        @media (max-width: 768px) {
            body {
                height: auto;
                min-height: 100vh;
                overflow: auto;
                align-items: flex-start;
            }

            #app-container {
                height: calc(100vh - 20px);
                margin: 10px;
                border-radius: 18px;
            }

            header {
                padding: 14px;
                gap: 10px;
            }

            .bot-status h1 {
                font-size: 1rem;
            }

            .quick-actions {
                flex-wrap: wrap;
                overflow-x: visible;
            }

            .action-btn {
                flex: 1 1 calc(50% - 8px);
                justify-content: center;
            }

            #chat-window {
                padding: 14px;
                gap: 12px;
            }

            .msg {
                max-width: 92%;
                font-size: 0.9rem;
            }

            .controls {
                padding: 0 14px 10px 14px;
            }

            #input-area {
                padding: 14px;
                gap: 10px;
            }
        }
    </style>
</head>

<body>

    <div id="app-container">
        <header>
            <div class="bot-info">
                <div class="bot-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="bot-status">
                    <h1 id="ui-title">SpeedPage Dev-Bot</h1>
                    <small><span class="status-dot"></span> Online Assistant</small>
                </div>
            </div>
            <div class="lang-switcher">
                <button class="lang-btn active" onclick="setLang('tr')">TR</button>
                <button class="lang-btn" onclick="setLang('en')">EN</button>
            </div>
        </header>

        <div id="chat-window">
            <!-- Messages will appear here -->
        </div>

        <div id="typing" class="typing-indicator">
            <span id="ui-typing">Asistan yazƒ±yor</span><span>.</span><span>.</span><span>.</span>
        </div>

        <div class="controls">
            <div class="quick-actions">
                <button class="action-btn" onclick="sendQuick('market')"><i class="fas fa-shopping-cart"></i> <span
                        id="btn-market">Market</span></button>
                <button class="action-btn" onclick="sendQuick('kategoriler')"><i class="fas fa-folder-tree"></i> <span
                        id="btn-files">Dosyalar</span></button>
                <button class="action-btn" onclick="openWizard()"><i class="fas fa-magic"></i> <span
                        id="btn-wizard">Sihirbaz</span></button>
                <button class="action-btn" onclick="sendQuick('≈üablon')"><i class="fas fa-file-code"></i> <span
                        id="btn-template">≈ûablon</span></button>
            </div>
            <div class="guide-container">
                <select id="fileSelect">
                    <option value="" id="ui-fileGuide">üîç Dosya Rehberi...</option>
                </select>
            </div>
        </div>

        <div id="input-area">
            <input type="text" id="userInput" placeholder="Bir ≈üey sor..." autocomplete="off">
            <button class="send-btn" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Wizard Modal -->
    <div id="modal-overlay" class="modal-overlay" onclick="closeWizard()">
        <div class="modal-body" onclick="event.stopPropagation()">
            <h3 id="w-title">Mod√ºl Sihirbazƒ±</h3>
            <input type="text" id="m_name" placeholder="Mod√ºl Adƒ± (√∂rn: my-plugin)">
            <input type="text" id="m_title" placeholder="G√∂r√ºn√ºr Ba≈ülƒ±k">
            <select id="m_perm">
                <option value="admin" id="w-perm-admin">Admin Yetkisi</option>
                <option value="editor" id="w-perm-editor">Edit√∂r Yetkisi</option>
                <option value="" id="w-perm-public">Herkes</option>
            </select>
            <button class="send-btn" style="width:100%" onclick="generateModuleJSON()">
                <span id="w-submit">Olu≈ütur & G√∂nder</span>
            </button>
        </div>
    </div>

    <script>
        let projectData = {};
        let currentLang = (navigator.language || '').toLowerCase().startsWith('tr') ? 'tr' : 'en';

        async function init() {
            try {
                const response = await fetch('proje.json');
                if (!response.ok) {
                    throw new Error(`proje.json fetch failed: ${response.status}`);
                }
                projectData = await response.json();
                if (!projectData.ui || !projectData.ui.tr || !projectData.ui.en) {
                    throw new Error('Invalid project data schema');
                }

                if (!projectData.ui[currentLang]) {
                    currentLang = 'tr';
                }

                updateUIStrings();
                setupFileGuide();
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.innerText.toLowerCase() === currentLang);
                });

                // Welcome message
                addMessage(projectData.ui[currentLang].welcome, 'bot');
            } catch (error) {
                console.error("Initialization failed:", error);
                addMessage(currentLang === 'tr'
                    ? 'Ba≈ülatma hatasƒ±: proje.json y√ºklenemedi.'
                    : 'Initialization error: failed to load proje.json.', 'bot');
            }
        }

        function setLang(lang) {
            if (!projectData.ui || !projectData.ui[lang]) return;
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.innerText.toLowerCase() === lang);
            });
            updateUIStrings();
            setupFileGuide();
            addMessage(lang === 'tr' ? "Dil T√ºrk√ße olarak deƒüi≈ütirildi." : "Language changed to English.", 'bot');
        }

        function updateUIStrings() {
            if (!projectData.ui || !projectData.ui[currentLang]) return;
            const ui = projectData.ui[currentLang];
            document.getElementById('ui-title').innerText = ui.title;
            document.getElementById('userInput').placeholder = ui.inputPlaceholder;
            document.getElementById('btn-market').innerText = ui.marketBtn;
            document.getElementById('btn-files').innerText = ui.filesBtn;
            document.getElementById('btn-wizard').innerText = ui.wizardBtn;
            document.getElementById('btn-template').innerText = ui.templateBtn;
            document.getElementById('ui-typing').innerText = ui.typing.replace('...', '');
            document.getElementById('ui-fileGuide').innerText = ui.fileGuide;

            // Wizard strings
            document.getElementById('w-title').innerText = ui.wizardTitle;
            document.getElementById('m_name').placeholder = ui.wizardName;
            document.getElementById('m_title').placeholder = ui.wizardHeader;
            document.getElementById('w-perm-admin').innerText = ui.wizardPermAdmin;
            document.getElementById('w-perm-editor').innerText = ui.wizardPermEditor;
            document.getElementById('w-perm-public').innerText = ui.wizardPermPublic;
            document.getElementById('w-submit').innerText = ui.wizardSubmit;
        }

        function setupFileGuide() {
            const select = document.getElementById('fileSelect');
            const placeholder = document.getElementById('ui-fileGuide');
            select.innerHTML = '';
            select.appendChild(placeholder);

            if (!projectData.faq) return;

            const files = [...new Set(projectData.faq.map(item => item.file).filter(Boolean))].sort();
            files.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f;
                opt.text = f;
                select.appendChild(opt);
            });

            select.onchange = (e) => {
                if (e.target.value) {
                    const found = projectData.faq.find(item => item.file === e.target.value);
                    addMessage(`${e.target.value}:`, 'user');
                    addMessageByObject(found);
                    select.value = '';
                }
            };
        }

        const inputField = document.getElementById('userInput');
        const chatWindow = document.getElementById('chat-window');
        const typingIndicator = document.getElementById('typing');

        inputField.addEventListener("keypress", (e) => e.key === "Enter" && sendMessage());

        async function sendMessage() {
            const text = inputField.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            inputField.value = '';
            typingIndicator.style.display = 'block';

            const response = await findResponse(text);

            setTimeout(() => {
                typingIndicator.style.display = 'none';
                if (typeof response === 'object' && response.answer) {
                    addMessageByObject(response);
                } else {
                    addMessage(response, 'bot');
                }
            }, 600);
        }

        async function findResponse(msg) {
            const lowerMsg = msg.toLowerCase();
            const words = lowerMsg.split(/[^a-zA-Z0-9√ßƒüƒ±√∂≈ü√º√áƒûƒ∞√ñ≈û√ú_-]+/).filter(Boolean);

            // Market / Marketplace commands
            if (lowerMsg.includes("market") || lowerMsg.includes("store") || lowerMsg.includes("liste") || lowerMsg.includes("shop")) {
                return await checkMarket();
            }

            // Architecture / Files commands
            if (lowerMsg.includes("dosyalar") || lowerMsg.includes("files") || lowerMsg.includes("kategori") || lowerMsg.includes("arch")) {
                const isTr = currentLang === 'tr';
                return `<b>${isTr ? 'üóÇÔ∏è Sistem Mimarisi' : 'üóÇÔ∏è System Architecture'}:</b><br><br>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:0.85rem;">
                    <div style="background:var(--bot-bubble); padding:10px; border-radius:12px; border:1px solid var(--glass-border);"><b>üîí ${isTr ? 'G√ºvenlik' : 'Security'}</b><br>auth.php, captcha_lib.php</div>
                    <div style="background:var(--bot-bubble); padding:10px; border-radius:12px; border:1px solid var(--glass-border);"><b>üóÑÔ∏è ${isTr ? 'Veri' : 'Data'}</b><br>db.php, db_switch.php</div>
                    <div style="background:var(--bot-bubble); padding:10px; border-radius:12px; border:1px solid var(--glass-border);"><b>üé® ${isTr ? 'Tema' : 'Theme'}</b><br>header.php, style.css</div>
                    <div style="background:var(--bot-bubble); padding:10px; border-radius:12px; border:1px solid var(--glass-border);"><b>üß† ${isTr ? 'Yapay Zeka' : 'A.I'}</b><br>AiCore.php, ai-panel.php</div>
                    <div style="background:var(--bot-bubble); padding:10px; border-radius:12px; border:1px solid var(--glass-border);"><b>üöÄ ${isTr ? 'Sistem' : 'System'}</b><br>index.php, settings.php, page.php</div>
                    <div style="background:var(--bot-bubble); padding:10px; border-radius:12px; border:1px solid var(--glass-border);"><b>üõ†Ô∏è ${isTr ? 'Kurulum' : 'Install'}</b><br>install.php, manifest.json</div>
                </div>`;
            }

            // Template / ≈üablon commands
            if (lowerMsg.includes("≈üablon") || lowerMsg.includes("template") || lowerMsg.includes("example")) {
                const fullTemplate = {
                    "name": "ornek-modul",
                    "title": "√ñrnek Mod√ºl Ba≈ülƒ±ƒüƒ±",
                    "version": "1.0.0",
                    "description": "Mod√ºl√ºn√ºz√ºn ne i≈üe yaradƒ±ƒüƒ±na dair kƒ±sa bir a√ßƒ±klama.",
                    "author": "Geli≈ütirici Adƒ±",
                    "php_version": "8.1",
                    "dependencies": [],
                    "permissions": ["admin", "editor"],
                    "is_active": 1,
                    "icon": "fa-puzzle-piece",
                    "create_page": true,
                    "page": "index.php",
                    "create_menu": true,
                    "menu_title": "√ñrnek Mod√ºl",
                    "menu_icon": "fa-star",
                    "locations": ["navbar"],
                    "db_setup": {
                        "install": "setup.php",
                        "uninstall": "cleanup.php"
                    },
                    "admin_menu": {
                        "title": "Mod√ºl Y√∂netimi",
                        "url": "admin-panel.php",
                        "icon": "fa-tools",
                        "admin_assets": {
                            "css": ["admin-style.css"],
                            "js": ["admin-logic.js"]
                        }
                    },
                    "pageassets": {
                        "css": ["style.css"],
                        "js": ["frontend-script.js"]
                    },
                    "hooks": "hooks.php",
                    "hooksassets": {
                        "css": ["global-notifications.css"],
                        "js": ["global-events.js"]
                    },
                    "assets": {
                        "images": ["logo.png"]
                    }
                };
                return `<b>üìÑ ${currentLang === 'tr' ? 'Tam module.json ≈ûablonu' : 'Full module.json Template'}:</b><br>
                <div class="code-block" style="max-height: 300px; overflow-y: auto;">${JSON.stringify(fullTemplate, null, 2)}</div>
                <br><i>${currentLang === 'tr' ? 'Not: Asset\'leri module.json √ºzerinden y√∂netmeyi unutma!' : 'Note: Don\'t forget to manage assets via module.json!'}</i>`;
            }

            // FAQ Search
            if (projectData.faq) {
                let bestMatch = null;
                let maxHits = -1;

                projectData.faq.forEach(item => {
                    const keys = item.keywords[currentLang] || [];
                    let hits = 0;
                    keys.forEach(k => {
                        const key = String(k || '').toLowerCase();
                        if (!key) return;
                        if (lowerMsg.includes(key)) hits += 3;
                        words.forEach(w => {
                            if (w && key.includes(w)) hits += 1;
                        });
                    });
                    if (hits > maxHits) {
                        maxHits = hits;
                        bestMatch = item;
                    }
                });

                if (bestMatch && maxHits > 0) return {
                    answer: bestMatch.answer[currentLang],
                    file: bestMatch.file
                };
            }

            return projectData.fallback[currentLang] || (currentLang === 'tr' ? "Anlayamadƒ±m..." : "I didn't understand...");
        }

        async function checkMarket() {
            let timeout = null;
            try {
                const modUrl = projectData?.projectInfo?.marketSources?.modules ||
                    'https://raw.githubusercontent.com/snrj35-dev/SpeedPage-modul-theme/main/modul/market.json';
                const themeUrl = projectData?.projectInfo?.marketSources?.themes ||
                    'https://raw.githubusercontent.com/snrj35-dev/SpeedPage-modul-theme/main/theme/market.json';

                const controller = new AbortController();
                timeout = setTimeout(() => controller.abort(), 12000);
                const [modRes, themeRes] = await Promise.all([
                    fetch(modUrl, { signal: controller.signal }),
                    fetch(themeUrl, { signal: controller.signal })
                ]);
                if (timeout) clearTimeout(timeout);
                if (!modRes.ok || !themeRes.ok) {
                    throw new Error(`Market HTTP error: ${modRes.status}/${themeRes.status}`);
                }

                const modules = await modRes.json();
                const themes = await themeRes.json();

                let list = `<b>üè™ SpeedPage Global Market</b><br><hr style="opacity:0.1; margin:10px 0;">`;
                list += `<b style="color:var(--primary-light)">üì¶ ${currentLang === 'tr' ? 'Mod√ºller' : 'Modules'}</b><br>`;

                const modItems = Array.isArray(modules) ? modules : (modules.modules || []);
                if (modItems.length > 0) {
                    modItems.forEach(m => {
                        const title = escapeHtml(m.title || m.name || 'Unknown');
                        const version = escapeHtml(m.version || '?');
                        const link = pickItemLink(m);
                        const linkHtml = link
                            ? ` <a href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer" style="color:var(--accent)">${currentLang === 'tr' ? '[ƒ∞ndir]' : '[Download]'}</a>`
                            : '';
                        list += `‚Ä¢ ${title} <small style="color:var(--text-muted)">(v${version})</small>${linkHtml}<br>`;
                    });
                } else {
                    list += `<i>${currentLang === 'tr' ? 'Mod√ºl bulunamadƒ±.' : 'No modules found.'}</i><br>`;
                }

                list += `<br><b style="color:var(--primary-light)">üé® ${currentLang === 'tr' ? 'Temalar' : 'Themes'}</b><br>`;

                const themeItems = Array.isArray(themes) ? themes : (themes.themes || themes.modules || []);
                if (themeItems.length > 0) {
                    themeItems.forEach(t => {
                        const title = escapeHtml(t.title || t.name || 'Unknown');
                        const version = escapeHtml(t.version || '?');
                        const link = pickItemLink(t);
                        const linkHtml = link
                            ? ` <a href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer" style="color:var(--accent)">${currentLang === 'tr' ? '[ƒ∞ndir]' : '[Download]'}</a>`
                            : '';
                        list += `‚Ä¢ ${title} <small style="color:var(--text-muted)">(v${version})</small>${linkHtml}<br>`;
                    });
                } else {
                    list += `<i>${currentLang === 'tr' ? 'Tema bulunamadƒ±.' : 'No themes found.'}</i><br>`;
                }

                list += `<br><i style="font-size:0.8rem; color:var(--text-muted)">${currentLang === 'tr' ? 'Y√ºklemek i√ßin admin panelini kullanƒ±n!' : 'Use admin panel to install!'}</i>`;
                return list;
            } catch (error) {
                return currentLang === 'tr'
                    ? "‚ùå Market verileri alƒ±namadƒ±. Baƒülantƒ± veya JSON formatƒ±nƒ± kontrol et."
                    : "‚ùå Could not fetch market data. Check network and JSON format.";
            } finally {
                if (timeout) clearTimeout(timeout);
            }
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function addMessage(text, side) {
            const div = document.createElement('div');
            div.className = `msg ${side}`;
            if (side === 'user') {
                div.textContent = text;
            } else {
                div.innerHTML = text;
            }
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function addMessageByObject(obj) {
            if (!obj || !obj.answer) {
                addMessage(currentLang === 'tr' ? 'Bu dosya i√ßin a√ßƒ±klama bulunamadƒ±.' : 'No description found for this file.', 'bot');
                return;
            }

            const div = document.createElement('div');
            div.className = `msg bot`;

            let content = obj.answer;
            if (typeof content === 'object') content = content[currentLang];
            content = escapeHtml(content).replace(/\n/g, '<br>');

            if (obj.file) {
                const legacyInfo = isLegacyFile(obj.file)
                    ? `<div style="margin-top:8px; font-size:0.78rem; color:#fbbf24;">‚ö†Ô∏è ${currentLang === 'tr' ? 'Bu dosya eski/legacy olabilir.' : 'This file reference may be legacy.'}</div>`
                    : '';
                content += `<div class="file-ref">
                    <i class="fas fa-file-code"></i>
                    <span>üìÅ src/${escapeHtml(obj.file)}</span>
                </div>${legacyInfo}`;
            }

            div.innerHTML = content;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function sendQuick(cmd) {
            inputField.value = cmd;
            sendMessage();
        }

        function openWizard() {
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function closeWizard() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        function generateModuleJSON() {
            const name = document.getElementById('m_name').value || 'new-modul';
            const title = document.getElementById('m_title').value || 'New Module';
            const perm = document.getElementById('m_perm').value;

            const template = {
                "name": name,
                "title": title,
                "version": "1.0.0",
                "permissions": perm ? [perm] : [],
                "is_active": 1,
                "db_setup": { "install": "setup.php", "uninstall": "cleanup.php" },
                "admin_menu": { "title": title, "url": "admin-panel.php", "icon": "fa-puzzle-piece" }
            };

            closeWizard();
            const msg = currentLang === 'tr' ? `<b>üßô‚Äç‚ôÇÔ∏è Sihirbaz Mod√ºl√ºn√ºz√º Olu≈üturdu:</b>` : `<b>üßô‚Äç‚ôÇÔ∏è Wizard Created Your Module:</b>`;
            addMessage(msg, 'bot');
            addMessage(`<div class="code-block">${JSON.stringify(template, null, 2)}</div>`, 'bot');
        }

        function pickItemLink(item) {
            const keys = ['download_url', 'zip_url', 'download', 'url', 'repo_url', 'github', 'link'];
            for (const key of keys) {
                const value = item?.[key];
                if (typeof value === 'string' && /^https?:\/\//i.test(value)) {
                    return value;
                }
            }
            return '';
        }

        function isLegacyFile(fileRef) {
            const list = projectData?.projectInfo?.legacyFiles || [];
            const normalizedRef = String(fileRef || '').toLowerCase();
            return list.some(entry => normalizedRef.includes(String(entry).toLowerCase()));
        }

        // Run init
        init();
    </script>
</body>

</html>
