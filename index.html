<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeedPage Dev-Bot v2.5</title>
    <style>
        :root {
            --bg: #f0f2f5;
            --bot: #ffffff;
            --user: #dcf8c6;
            --accent: #25d366;
            --dark: #075e54;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        #chat-container {
            min-width: 420px;
            min-height: 550px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-width: 800px;
            max-height: 90%;
        }

        #header {
            background: var(--dark);
            color: white;
            padding: 20px;
            text-align: center;
            font-weight: bold;
        }

        #chat-window {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #e5ddd5;
        }

        .msg {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 0.95rem;
            position: relative;
            animation: fadeIn 0.3s ease;
        }

        .bot {
            align-self: flex-start;
            background: var(--bot);
            border-top-left-radius: 2px;
        }

        .user {
            align-self: flex-end;
            background: var(--user);
            border-top-right-radius: 2px;
        }

        .file-tag {
            display: block;
            font-size: 0.75rem;
            color: #25d366;
            margin-top: 5px;
            font-weight: bold;
            border-top: 1px solid #eee;
            padding-top: 3px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #input-area {
            display: flex;
            padding: 15px;
            background: #f0f0f0;
        }

        input {
            flex: 1;
            border: none;
            padding: 12px 18px;
            border-radius: 25px;
            outline: none;
        }

        button {
            background: var(--accent);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-left: 10px;
            cursor: pointer;
        }

        .typing {
            font-size: 0.8rem;
            color: #666;
            padding: 5px 20px;
            display: none;
            background: #e5ddd5;
        }

        .msg b {
            color: var(--dark);
        }

        .msg small {
            opacity: 0.8;
        }

        .q-btn {
            background: var(--dark);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.75rem;
            cursor: pointer;
            width: auto;
            margin: 0;
            height: auto;
        }

        .q-btn {
            background: var(--dark);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        /* Modal TasarÄ±mÄ± */
        #modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            width: 300px;
        }

        #modal input,
        #modal select {
            width: 100%;
            margin-bottom: 10px;
            padding: 8px;
            box-sizing: border-box;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
    </style>
</head>

<body>

    <div id="chat-container">
        <div id="header">ğŸ¤– SpeedPage Market & Dev-Bot</div>
        <div id="chat-window">
            <div class="msg bot">Selam! Ben SpeedPage asistanÄ±. Market listesini gÃ¶rmek iÃ§in "market" yazabilirsin!
            </div>
        </div>
        <div id="typing" class="typing">Asistan yazÄ±yor...</div>
        <div id="input-area">
            <input type="text" id="userInput" placeholder="Bir ÅŸey sor..." autocomplete="off">
            <button onclick="sendMessage()">â¤</button>
        </div>
        <div class="quick-btns">
            <button class="q-btn" onclick="sendQuick('market')">ğŸ›’ Market</button>
            <button class="q-btn" onclick="sendQuick('kategoriler')">ğŸ—‚ï¸ Dosyalar</button>
            <button class="q-btn" onclick="openWizard()">ğŸ§™â€â™‚ï¸ Sihirbaz</button>
            <button class="q-btn" onclick="sendQuick('ÅŸablon')">ğŸ“„ module Åablonu</button>

        </div>

        <div id="overlay" class="overlay" onclick="closeWizard()"></div>
        <div id="modal">
            <h3>ğŸ§™â€â™‚ï¸ ModÃ¼l SihirbazÄ±</h3>
            <input type="text" id="m_name" placeholder="ModÃ¼l AdÄ± (Ã¶rn: my-plugin)">
            <input type="text" id="m_title" placeholder="GÃ¶rÃ¼nÃ¼r BaÅŸlÄ±k">
            <select id="m_perm">
                <option value="admin">Admin Yetkisi</option>
                <option value="editor">EditÃ¶r Yetkisi</option>
                <option value="">Herkes</option>
            </select>
            <button class="q-btn" style="width:100%" onclick="generateModuleJSON()">OluÅŸtur & GÃ¶nder</button>
        </div>
    </div>

    <script>
        let projectData = {};

        fetch('./proje.json')
            .then(response => response.json())
            .then(data => {
                projectData = data;
                // ... diÄŸer iÅŸlemler
            });

        const inputField = document.getElementById('userInput');
        const chatWindow = document.getElementById('chat-window');
        const typingIndicator = document.getElementById('typing');

        inputField.addEventListener("keypress", (e) => e.key === "Enter" && sendMessage());

        async function sendMessage() {
            const text = inputField.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            inputField.value = '';
            typingIndicator.style.display = 'block';

            // KRÄ°TÄ°K: await ekledik ki market verisi gelene kadar beklesin
            const response = await findResponse(text);

            setTimeout(() => {
                typingIndicator.style.display = 'none';

                // EÄŸer gelen yanÄ±t bir obje ise (FAQ'dan gelmiÅŸse)
                if (typeof response === 'object' && response.answer) {
                    addMessage(response.answer, 'bot', response.file);
                } else {
                    // EÄŸer dÃ¼z metin ise (Market listesi veya fallback)
                    addMessage(response, 'bot');
                }
            }, 600);
        }

        async function findResponse(msg) {
            const lowerMsg = msg.toLowerCase();

            if (lowerMsg.includes("market") || lowerMsg.includes("liste")) {
                return await checkMarket();
            }
            // findResponse iÃ§ine eklenebilir
            if (lowerMsg.includes("dosyalar") || lowerMsg.includes("kategori")) {
                return `<b>ğŸ—‚ï¸ Sistem Mimarisi:</b><br><br>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; font-size:0.8rem;">
        <div style="background:#fff; padding:5px; border-radius:5px;"><b>ğŸ”’ GÃ¼venlik:</b> auth.php, captcha_lib.php</div>
        <div style="background:#fff; padding:5px; border-radius:5px;"><b>ğŸ—„ï¸ Veri:</b> db.php, db_switch.php</div>
        <div style="background:#fff; padding:5px; border-radius:5px;"><b>ğŸ¨ Tema:</b> header.php, style.css</div>
        <div style="background:#fff; padding:5px; border-radius:5px;"><b>ğŸ§  Yapay Zeka:</b> AiCore.php, ai-panel.php</div>
    </div>`;
            }

            // findResponse iÃ§ine eklenebilir
            if (lowerMsg.includes("yeni modÃ¼l oluÅŸtur") || lowerMsg.includes("sihirbaz")) {
                const wizardTemplate = {
                    name: "yeni-modul",
                    title: "Yeni ModÃ¼l",
                    version: "1.0.0",
                    permissions: ["admin"], // RBAC desteÄŸi
                    db_setup: { install: "setup.php", uninstall: "cleanup.php" }, // YaÅŸam dÃ¶ngÃ¼sÃ¼
                    admin_menu: { title: "YÃ¶netim", url: "admin-panel.php", icon: "fa-tools" }
                };

                return `<b>ğŸ§™â€â™‚ï¸ SpeedPage ModÃ¼l SihirbazÄ±</b><br>
    Ä°ÅŸte temel yapÄ±landÄ±rman! Bu iÃ§eriÄŸi <code>module.json</code> olarak kaydedebilirsin.<br>
    <pre style="background:#272822; color:#fff; padding:10px; border-radius:5px; overflow-x:auto; font-size:0.75rem;">
${JSON.stringify(wizardTemplate, null, 2)}
    </pre>
    <br><i>Not: Asset'leri (CSS/JS) module.json Ã¼zerinden yÃ¶netmeyi unutma!</i>`;
            }

            if (lowerMsg.includes("ÅŸablon") || lowerMsg.includes("Ã¶rnek modÃ¼l")) {
                return `<b>ğŸ“„ Standart module.json Åablonu:</b><br>
    <pre style="background: #272822; color: #fff; padding: 10px; border-radius: 5px; font-size: 0.8rem; overflow-x: auto;">
{
    "name": "ornek-modul",
    "title": "Ã–rnek ModÃ¼l BaÅŸlÄ±ÄŸÄ±",
    "version": "1.0.0",
    "description": "ModÃ¼lÃ¼nÃ¼zÃ¼n ne iÅŸe yaradÄ±ÄŸÄ±na dair kÄ±sa bir aÃ§Ä±klama.",
    "author": "GeliÅŸtirici AdÄ±",
    "php_version": "8.1",
    "dependencies": [],
    /* --- YETKÄ°LENDÄ°RME (YENÄ°) --- */
    "permissions": ["admin", "editor"], // Sadece bu rollere sahip kullanÄ±cÄ±lar modÃ¼le eriÅŸebilir. BoÅŸ bÄ±rakÄ±lÄ±rsa herkes eriÅŸir.
    /* --- GÃ–RÃœNÃœM VE SAYFA AYARLARI --- */
    "is_active": 1,
    "icon": "fa-puzzle-piece",
    "create_page": true,         // ModÃ¼l iÃ§in otomatik bir frontend sayfasÄ± oluÅŸturulsun mu?
    "page": "index.php",        // Frontend sayfasÄ±nÄ±n ana dosyasÄ± (modules/ornek-modul/ iÃ§inde)
    "create_menu": true,         // Navbar'a otomatik menÃ¼ eklensin mi?
    "menu_title": "Ã–rnek ModÃ¼l", // MenÃ¼de gÃ¶rÃ¼necek isim
    "menu_icon": "fa-star",      // MenÃ¼ simgesi (FontAwesome)
    "locations": ["navbar"],     // MenÃ¼nÃ¼n gÃ¶rÃ¼neceÄŸi yerler (navbar, footer, sidebar vb.)
    /* --- YAÅAM DÃ–NGÃœSÃœ SCRIPTLERÄ° (YENÄ°) --- */
    "db_setup": {
        "install": "setup.php",    // ModÃ¼l yÃ¼klendiÄŸinde otomatik Ã§alÄ±ÅŸtÄ±rÄ±lacak PHP dosyasÄ± (Tablo oluÅŸturma vb.)
        "uninstall": "cleanup.php"  // ModÃ¼l silindiÄŸinde temizlik yapacak PHP dosyasÄ±
    },
    /* --- ADMÄ°N PANELÄ° AYARLARI --- */
    "admin_menu": {
        "title": "ModÃ¼l YÃ¶netimi",
        "url": "admin-panel.php", // Admin panel dosyasÄ± (modules/ornek-modul/ iÃ§inde)
        "icon": "fa-tools",
        
        "admin_assets": {         // SADECE Admin Panelinde yÃ¼klenecek dosyalar
            "css": ["admin-style.css"],
            "js": ["admin-logic.js"]
        }
    },
    /* --- FRONTEND ASSET AYARLARI --- */
    "pageassets": {               // SADECE ModÃ¼lÃ¼n kendi sayfasÄ±nda yÃ¼klenecek dosyalar
        "css": ["style.css"],
        "js": ["frontend-script.js"]
    },
    /* --- SÄ°STEM GENELÄ° (HOOK) ASSETLERÄ° --- */
    "hooks": "hooks.php",         // Hook (kanca) tanÄ±mlamalarÄ±nÄ±n olduÄŸu PHP dosyasÄ±
    "hooksassets": {              // SÄ°TENÄ°N HER YERÄ°NDE (Admin dahil) yÃ¼klenecek dosyalar
        "css": ["global-notifications.css"],
        "js": ["global-events.js"]
    },
    /* --- EKSTRA VARLIKLAR --- */
    "assets": {
        "images": ["logo.png"]   // cdn/images/ornek-modul/ altÄ±na otomatik kopyalanÄ±r
    }
}
    </pre>
    <br><i>DetaylÄ± rehber iÃ§in 'module.json nedir' yazabilirsin!</i>`;
            }
            if (projectData.faq) {
                // En Ã§ok anahtar kelime eÅŸleÅŸmesi olan sonucu bulur
                let bestMatch = null;
                let maxHits = 0;

                projectData.faq.forEach(item => {
                    const hits = item.keywords.filter(k => lowerMsg.includes(k.toLowerCase())).length;
                    if (hits > maxHits) {
                        maxHits = hits;
                        bestMatch = item;
                    }
                });

                if (bestMatch) return { answer: bestMatch.answer, file: bestMatch.file };
            }

            return projectData.fallback || "AnlayamadÄ±m, tekrar eder misin?";
        }

        async function checkMarket() {
            try {
                // Ä°ki kaynaÄŸÄ± aynÄ± anda (paralel) Ã§ekiyoruz
                const [modRes, themeRes] = await Promise.all([
                    fetch('https://raw.githubusercontent.com/snrj35-dev/SpeedPage-modul-theme/main/modul/market.json'),
                    fetch('https://raw.githubusercontent.com/snrj35-dev/SpeedPage-modul-theme/refs/heads/main/theme/market.json')
                ]);

                const modules = await modRes.json();
                const themes = await themeRes.json();

                let list = "<b>ğŸª SpeedPage Global Market</b><br><hr>";

                // --- MODÃœLLER BÃ–LÃœMÃœ ---
                list += "<b>ğŸ“¦ ModÃ¼ller</b><br>";
                const modItems = Array.isArray(modules) ? modules : (modules.modules || []);
                if (modItems.length > 0) {
                    modItems.forEach(m => {
                        list += `â€¢ ${m.title || m.name} <small>(v${m.version})</small><br>`;
                    });
                } else {
                    list += "<i>ModÃ¼l bulunamadÄ±.</i><br>";
                }

                list += "<br><b>ğŸ¨ Temalar</b><br>";

                // --- TEMALAR BÃ–LÃœMÃœ ---
                const themeItems = Array.isArray(themes) ? themes : (themes.themes || themes.modules || []);
                if (themeItems.length > 0) {
                    themeItems.forEach(t => {
                        list += `â€¢ ${t.title || t.name} <small>(v${t.version})</small><br>`;
                    });
                } else {
                    list += "<i>Tema bulunamadÄ±.</i><br>";
                }

                list += "<br><i>YÃ¼klemek iÃ§in admin panelini kullanÄ±n!</i>";
                return list;

            } catch (error) {
                console.error("Market hatasÄ±:", error);
                return "âŒ Market verileri Ã§ekilirken bir hata oluÅŸtu. LÃ¼tfen baÄŸlantÄ±nÄ±zÄ± kontrol edin.";
            }
        }
        function addMessage(text, side, file = null) {
            const div = document.createElement('div');
            div.className = `msg ${side}`;
            let content = text;

            if (file) {
                // Dosyaya gÃ¶re rozet rengi ve ismi belirleme
                let badgeColor = "#666";
                let badgeText = "Dosya";

                if (file.includes('json')) { badgeColor = "#e67e22"; badgeText = "YapÄ±landÄ±rma"; }
                else if (file.includes('php')) { badgeColor = "#3498db"; badgeText = "Sistem Ã‡ekirdeÄŸi"; }
                else if (file.includes('css')) { badgeColor = "#9b59b6"; badgeText = "TasarÄ±m"; }

                content += `<div style="margin-top:8px; border-left: 3px solid var(--accent); padding-left:10px;">
                    <small style="color:#666; display:block;">ğŸ“– Teknik Referans:</small>
                    <span class="file-tag" style="background:#eee; padding:2px 6px; border-radius:4px; font-size:0.7rem;">
                        ğŸ“ src/${file}
                    </span>
                </div>`;
            }

            div.innerHTML = content;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        // 1. Dropdown'u dolduran fonksiyon (Fetch sonuna ekle)
        function setupFileGuide() {
            const guideDiv = document.createElement('div');
            guideDiv.style = "padding: 10px; background: #eee; display: flex; gap: 5px; align-items: center;";

            // Dosya listesini FAQ'dan benzersiz olarak al
            const files = [...new Set(projectData.faq.map(item => item.file))];

            let options = `<option value="">ğŸ” Dosya Rehberi...</option>`;
            files.forEach(f => options += `<option value="${f}">${f}</option>`);

            guideDiv.innerHTML = `<select id="fileSelect" style="flex:1; border-radius:10px; padding:5px;">${options}</select>`;
            document.getElementById('chat-container').insertBefore(guideDiv, document.getElementById('input-area'));

            document.getElementById('fileSelect').onchange = (e) => {
                if (e.target.value) {
                    const found = projectData.faq.find(item => item.file === e.target.value);
                    addMessage(`<b>${e.target.value}</b> dosyasÄ±nÄ± sordun:`, 'user');
                    addMessage(found.answer, 'bot', found.file);
                }
            };
        }

        // fetch iÅŸlemini ÅŸununla gÃ¼ncelle:
        fetch('proje.json')
            .then(r => r.json())
            .then(d => {
                projectData = d;
                setupFileGuide(); // Dropdown'u kur
            });


        function sendQuick(cmd) {
            inputField.value = cmd;
            sendMessage();
        }

        function openWizard() {
            document.getElementById('modal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function closeWizard() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function generateModuleJSON() {
            const name = document.getElementById('m_name').value || 'new-modul';
            const title = document.getElementById('m_title').value || 'Yeni ModÃ¼l';
            const perm = document.getElementById('m_perm').value;

            const template = {
                "name": name,
                "title": title,
                "version": "1.0.0",
                "permissions": perm ? [perm] : [],
                "is_active": 1,
                "db_setup": { "install": "setup.php", "uninstall": "cleanup.php" },
                "admin_menu": { "title": title, "url": "admin-panel.php", "icon": "fa-puzzle-piece" }
            };

            closeWizard();
            addMessage("<b>ğŸ§™â€â™‚ï¸ Sihirbaz ModÃ¼lÃ¼nÃ¼zÃ¼ OluÅŸturdu:</b>", 'bot');
            addMessage(`<pre style="background:#272822; color:#fff; padding:10px; border-radius:5px; font-size:0.75rem; overflow-x:auto;">${JSON.stringify(template, null, 2)}</pre>`, 'bot');
        }   
    </script>
</body>

</html>